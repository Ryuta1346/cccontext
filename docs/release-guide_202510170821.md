# CCContext リリース手順書

> 最終更新: 2025-10-17

## 目次

1. [概要](#概要)
2. [リリース前の準備](#リリース前の準備)
3. [バージョン更新手順](#バージョン更新手順)
4. [CHANGELOG更新](#changelog更新)
5. [ビルドと検証](#ビルドと検証)
6. [Git操作](#git操作)
7. [npm公開](#npm公開)
8. [GitHub Release作成](#github-release作成)
9. [リリース後の確認](#リリース後の確認)
10. [トラブルシューティング](#トラブルシューティング)
11. [リリースチェックリスト](#リリースチェックリスト)

---

## 概要

本ドキュメントは、CCContextプロジェクトの新バージョンをリリースする際の標準手順を定義しています。

### リリースプロセスの目的

- **品質保証**: リリース前の徹底的なテストとチェックにより、高品質なパッケージを提供
- **トレーサビリティ**: バージョン管理とCHANGELOGの整備により、変更履歴を明確化
- **再現性**: 標準化された手順により、誰でも同じ品質でリリース可能
- **安全性**: チェックリストによる確認で、リリース時のミスを防止

### Semantic Versioning

本プロジェクトは[Semantic Versioning 2.0.0](https://semver.org/)に従います。

- **MAJOR** (x.0.0): 後方互換性のない変更
- **MINOR** (0.x.0): 後方互換性のある機能追加
- **PATCH** (0.0.x): 後方互換性のあるバグ修正

---

## リリース前の準備

### 1. コードフリーズ

リリース準備に入る前に、以下を確認してください：

```bash
# 最新のmainブランチを取得
git checkout main
git pull origin main

# 作業ツリーがクリーンであることを確認
git status
# → "nothing to commit, working tree clean" が表示されること
```

### 2. 依存関係の確認

```bash
# node_modulesを再インストール
rm -rf node_modules
pnpm install
# または
npm install
```

### 3. 全テストの実行

```bash
# ユニットテスト
npm test

# カバレッジ確認
npm run coverage
```

**期待される結果**: すべてのテストがPASSすること

### 4. 型チェック

```bash
npm run typecheck
```

**期待される結果**: 型エラーが0件であること

### 5. Lint & Format チェック

```bash
# Lintチェック
npm run lint

# フォーマットチェック
npm run check
```

**期待される結果**: エラーが0件であること（警告は許容される場合あり）

### 6. ビルドの事前確認

```bash
# クリーンビルド
npm run clean
npm run build
```

**期待される結果**: ビルドが成功し、`dist/` ディレクトリにファイルが生成されること

---

## バージョン更新手順

### 1. リリースタイプの決定

変更内容に基づいて、リリースタイプを決定します：

| リリースタイプ | 使用ケース | コマンド例 |
|--------------|-----------|----------|
| **patch** | バグ修正のみ | `npm version patch` |
| **minor** | 新機能追加（後方互換性あり） | `npm version minor` |
| **major** | 破壊的変更 | `npm version major` |

### 2. バージョンの更新

**方法A: npm versionコマンドを使用（推奨）**

```bash
# patch リリースの場合 (例: 1.2.0 → 1.2.1)
npm version patch

# minor リリースの場合 (例: 1.2.0 → 1.3.0)
npm version minor

# major リリースの場合 (例: 1.2.0 → 2.0.0)
npm version major
```

このコマンドは以下を自動的に実行します：
- `package.json` のバージョン更新
- Gitコミットの作成
- Gitタグの作成

**方法B: 手動更新**

```bash
# package.jsonを手動で編集
# "version": "1.2.0" → "version": "1.3.0"
```

### 3. バージョン更新の確認

```bash
# package.jsonの確認
cat package.json | grep version

# Gitログの確認（npm versionを使用した場合）
git log --oneline -1
```

---

## CHANGELOG更新

### 1. CHANGELOGの編集

`CHANGELOG.md` を編集し、新バージョンの変更内容を追加します。

**フォーマット例**:

```markdown
## [1.3.0] - 2025-10-17

### Added
- 新機能Aを追加 (#123)
- 新機能Bを追加 (#124)

### Changed
- 既存機能Cを改善 (#125)
- パフォーマンスを向上 (#126)

### Fixed
- バグDを修正 (#127)
- 表示の不具合を修正 (#128)

### Deprecated
- 非推奨となる機能E（v2.0.0で削除予定）

### Security
- セキュリティ脆弱性Fを修正 (#129)
```

### 2. カテゴリの使い分け

- **Added**: 新機能
- **Changed**: 既存機能の変更
- **Deprecated**: 非推奨になった機能
- **Removed**: 削除された機能
- **Fixed**: バグ修正
- **Security**: セキュリティ関連の修正

### 3. バージョンリンクの更新

CHANGELOG末尾のバージョンリンクを更新します：

```markdown
[1.3.0]: https://github.com/ryuta1346/cccontext/compare/v1.2.0...v1.3.0
```

### 4. CHANGELOGのコミット

```bash
git add CHANGELOG.md
git commit -m "docs: update CHANGELOG for v1.3.0"
```

---

## ビルドと検証

### 1. クリーンビルド

```bash
# 既存のビルド成果物を削除
npm run clean

# ビルド実行
npm run build
```

### 2. バンドルサイズの確認

```bash
npm run size
```

**確認事項**:
- サイズリミットを超えていないか
- 前バージョンと比較して、不自然なサイズ増加がないか

### 3. 公開ファイルの確認

```bash
# パッケージをローカルで作成
npm pack

# 生成されたtarballの内容を確認
tar -tzf cccontext-*.tgz
```

**確認事項**:
- 必要なファイル（dist/, README.md, LICENSE）が含まれている
- 不要なファイル（src/, test/, .claude/）が除外されている

### 4. ローカルテスト

```bash
# グローバルインストールのテスト
npm install -g ./cccontext-*.tgz

# 動作確認
cccontext --version
cccontext --help
cccontext sessions

# アンインストール
npm uninstall -g cccontext

# tarballの削除
rm cccontext-*.tgz
```

---

## Git操作

### 1. 最終コミット

npm versionコマンドを使用しなかった場合、手動でコミットします：

```bash
git add package.json CHANGELOG.md
git commit -m "chore: release v1.3.0"
```

### 2. Gitタグの作成

npm versionコマンドを使用しなかった場合、手動でタグを作成します：

```bash
# タグを作成
git tag -a v1.3.0 -m "Release version 1.3.0"

# タグの確認
git tag -l
git show v1.3.0
```

### 3. リモートへのプッシュ

```bash
# コミットとタグをプッシュ
git push origin main
git push origin v1.3.0

# または、すべてのタグを一度にプッシュ
git push origin main --tags
```

**確認**: GitHubのリポジトリページでコミットとタグが反映されていることを確認

---

## npm公開

### 1. npm認証の確認

```bash
# ログイン状態の確認
npm whoami

# ログインしていない場合
npm login
```

**必要な情報**:
- npmアカウント名
- パスワード
- メールアドレス
- 2FAコード（有効にしている場合）

### 2. 公開前の最終確認

```bash
# 公開されるファイルのリストを確認
npm publish --dry-run
```

**確認事項**:
- package.jsonの情報が正しい
- 公開するファイルが適切
- バージョン番号が正しい

### 3. npm公開の実行

```bash
npm publish
```

**注意**:
- `prepublishOnly` スクリプトが自動実行され、ビルドとサイズチェックが行われます
- 2FAが有効な場合、ワンタイムパスワードの入力が求められます

### 4. 公開の確認

```bash
# npmレジストリで確認
npm view cccontext

# 最新バージョンの確認
npm view cccontext version

# ブラウザで確認
# https://www.npmjs.com/package/cccontext
```

---

## GitHub Release作成

### 1. GitHub Releaseページへアクセス

https://github.com/ryuta1346/cccontext/releases/new

### 2. リリース情報の入力

**Tag version**: `v1.3.0`（既存のタグを選択）

**Release title**: `v1.3.0`

**Description**: CHANGELOGの該当バージョンの内容をコピー

例：
```markdown
## 🎉 What's New in v1.3.0

### ✨ Added
- 新機能Aを追加 (#123)
- 新機能Bを追加 (#124)

### 🔧 Changed
- 既存機能Cを改善 (#125)
- パフォーマンスを向上 (#126)

### 🐛 Fixed
- バグDを修正 (#127)
- 表示の不具合を修正 (#128)

---

**Full Changelog**: https://github.com/ryuta1346/cccontext/compare/v1.2.0...v1.3.0

**npm**: https://www.npmjs.com/package/cccontext/v/1.3.0
```

### 3. リリースオプション

- ☑ **Set as the latest release**（通常のリリースの場合）
- ☐ **Set as a pre-release**（ベータ版などの場合のみ）

### 4. リリースの公開

**Publish release** ボタンをクリック

---

## リリース後の確認

### 1. npmからのインストールテスト

```bash
# 新しいディレクトリで確認
mkdir /tmp/cccontext-test
cd /tmp/cccontext-test

# インストール
npm install -g cccontext

# バージョン確認
cccontext --version
# → 新しいバージョンが表示されること

# 動作確認
cccontext --help
cccontext sessions

# クリーンアップ
npm uninstall -g cccontext
cd -
rm -rf /tmp/cccontext-test
```

### 2. npxでの実行確認

```bash
npx cccontext@latest --version
```

### 3. ドキュメントの確認

以下のページで情報が正しく表示されることを確認：

- **npm**: https://www.npmjs.com/package/cccontext
- **GitHub**: https://github.com/ryuta1346/cccontext
- **GitHub Releases**: https://github.com/ryuta1346/cccontext/releases

### 4. 各言語のREADMEを更新（必要に応じて）

- README.ja.md
- README.zh.md
- README.ko.md
- README.es.md

---

## トラブルシューティング

### 公開時のエラー: "You do not have permission to publish"

**原因**: npmアカウントに公開権限がない

**解決策**:
```bash
# 正しいアカウントでログイン
npm logout
npm login

# 再度公開
npm publish
```

### 公開時のエラー: "Cannot publish over existing version"

**原因**: 同じバージョンが既に公開されている

**解決策**:
```bash
# バージョンを上げる
npm version patch

# 再度公開
npm publish
```

### ビルドエラー: "Module not found"

**原因**: 依存関係が正しくインストールされていない

**解決策**:
```bash
# 依存関係を再インストール
rm -rf node_modules package-lock.json
npm install

# 再ビルド
npm run build
```

### Gitタグのエラー: "tag already exists"

**原因**: 同じ名前のタグが既に存在する

**解決策**:
```bash
# 既存のタグを削除（ローカル）
git tag -d v1.3.0

# 既存のタグを削除（リモート）
git push origin :refs/tags/v1.3.0

# タグを再作成
git tag -a v1.3.0 -m "Release version 1.3.0"
git push origin v1.3.0
```

### ロールバック手順

公開後に重大な問題が発覚した場合：

```bash
# 1. npmパッケージを非推奨としてマーク
npm deprecate cccontext@1.3.0 "Critical bug found. Please use v1.2.0"

# 2. 問題を修正した新バージョンをリリース
npm version patch  # v1.3.1
# ... 通常のリリース手順に従う

# 注意: npm unpublishは公開後24時間以内のみ可能
# npm unpublish cccontext@1.3.0
```

---

## リリースチェックリスト

リリース作業時は、このチェックリストを使用して各ステップを確認してください。

### リリース前の準備

- [ ] mainブランチが最新状態
- [ ] 作業ツリーがクリーン
- [ ] 依存関係を再インストール
- [ ] すべてのテストがPASS
- [ ] 型チェックがPASS
- [ ] LintチェックがPASS
- [ ] ビルドが成功

### バージョン更新

- [ ] リリースタイプを決定（patch/minor/major）
- [ ] package.jsonのバージョンを更新
- [ ] バージョン更新を確認

### CHANGELOG更新

- [ ] CHANGELOGに新バージョンの変更内容を追加
- [ ] カテゴリ分けが適切
- [ ] バージョンリンクを更新
- [ ] CHANGELOGをコミット

### ビルドと検証

- [ ] クリーンビルドが成功
- [ ] バンドルサイズが適切
- [ ] npm packで公開ファイルを確認
- [ ] ローカルでインストールテスト
- [ ] 動作確認（--version, --help, sessions）

### Git操作

- [ ] 最終コミットを作成
- [ ] Gitタグを作成
- [ ] mainブランチをプッシュ
- [ ] タグをプッシュ
- [ ] GitHubで反映を確認

### npm公開

- [ ] npm認証を確認
- [ ] npm publish --dry-run で確認
- [ ] npm publish を実行
- [ ] npmレジストリで公開を確認

### GitHub Release

- [ ] GitHub Releaseページで新規作成
- [ ] タグを選択
- [ ] タイトルとDescriptionを入力
- [ ] リリースオプションを設定
- [ ] リリースを公開

### リリース後の確認

- [ ] npmからインストールテスト
- [ ] npxでの実行確認
- [ ] npm, GitHub, GitHub Releasesの表示確認
- [ ] 必要に応じて各言語READMEを更新

### コミュニケーション（必要に応じて）

- [ ] リリースノートを関係者に共有
- [ ] SNSでアナウンス
- [ ] ユーザーへの通知

---

## 参考リンク

- **Semantic Versioning**: https://semver.org/
- **Keep a Changelog**: https://keepachangelog.com/
- **npm publish documentation**: https://docs.npmjs.com/cli/v9/commands/npm-publish
- **GitHub Releases**: https://docs.github.com/en/repositories/releasing-projects-on-github

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-10-17 | 1.0.0 | 初版作成 |
