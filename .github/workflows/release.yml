name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry-run:
        description: "Dry run (skip npm publish)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm run typecheck

      - name: Lint
        run: pnpm run check

      - name: Build
        run: pnpm run build

      - name: Test
        run: pnpm run test

      - name: Check bundle size
        run: pnpm run size

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: version
        run: |
          OLD_VERSION=$(node -p "require('./package.json').version")
          npm version ${{ inputs.version }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "old_version=$OLD_VERSION" >> "$GITHUB_OUTPUT"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumped version: $OLD_VERSION -> $NEW_VERSION"

      - name: Update CHANGELOG.md
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          OLD_VERSION="${{ steps.version.outputs.old_version }}"
          DATE=$(date +%Y-%m-%d)
          REPO_URL="https://github.com/ryuta1346/cccontext"

          # Generate commit log since last version change
          COMMITS=$(git log --pretty=format:"- %s" HEAD...$(git log --all --oneline --grep="^${OLD_VERSION}$" --format="%H" | head -1) 2>/dev/null || git log --pretty=format:"- %s" -10)

          # Create new changelog entry
          ENTRY=$(printf "## [%s] - %s\n\n### Changed\n\n%s\n" "$NEW_VERSION" "$DATE" "$COMMITS")

          # Insert before the first ## heading (after the # Changelog title)
          LINE_NUM=$(grep -n "^## " CHANGELOG.md | head -1 | cut -d: -f1)
          if [ -n "$LINE_NUM" ]; then
            { head -n $((LINE_NUM - 1)) CHANGELOG.md; printf '%s\n\n' "$ENTRY"; tail -n +"$LINE_NUM" CHANGELOG.md; } > tmp_changelog && mv tmp_changelog CHANGELOG.md
          else
            { printf '%s\n\n' "$ENTRY"; cat CHANGELOG.md; } > tmp_changelog && mv tmp_changelog CHANGELOG.md
          fi

          # Update comparison link at the bottom
          if grep -q "\[unreleased\]:" CHANGELOG.md; then
            sed -i "s|\[unreleased\]:.*|\[unreleased\]: ${REPO_URL}/compare/v${NEW_VERSION}...HEAD|" CHANGELOG.md
          fi

          # Add version comparison link if not exists
          if ! grep -q "\[${NEW_VERSION}\]:" CHANGELOG.md; then
            echo "[${NEW_VERSION}]: ${REPO_URL}/compare/v${OLD_VERSION}...v${NEW_VERSION}" >> CHANGELOG.md
          fi

      - name: Create release branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          OLD_VERSION="${{ steps.version.outputs.old_version }}"
          BRANCH="release/v${NEW_VERSION}"

          # Clean up existing release branch/PR from previous attempts
          if git ls-remote --exit-code origin "refs/heads/$BRANCH" > /dev/null 2>&1; then
            echo "Remote branch $BRANCH already exists. Cleaning up..."
            EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number // empty')
            if [ -n "$EXISTING_PR" ]; then
              echo "Closing existing PR #${EXISTING_PR}..."
              gh pr close "$EXISTING_PR" --delete-branch
            else
              git push origin --delete "$BRANCH"
            fi
          fi

          git checkout -b "$BRANCH"
          git add package.json CHANGELOG.md
          git commit -m "release: v${NEW_VERSION}"
          git push origin "$BRANCH"

          DRY_RUN_LABEL=""
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            DRY_RUN_LABEL="--label release:dry-run"
          fi

          gh pr create \
            --title "release: v${NEW_VERSION}" \
            --body "## Release v${NEW_VERSION}

          Automated release PR.

          **Version**: ${OLD_VERSION} â†’ ${NEW_VERSION}

          Once this PR is merged, the publish workflow will automatically:
          - Create the \`v${NEW_VERSION}\` tag
          - Publish to npm
          - Create a GitHub Release" \
            --base main \
            --head "$BRANCH" \
            --label release $DRY_RUN_LABEL
