# /compact 検出問題の分析

## 問題の概要
`/compact` コマンド実行後、cccontext の表示に変更が反映されない

## 原因として考えられる要因

### 1. **デバウンシング設定の問題**
```javascript
awaitWriteFinish: {
  stabilityThreshold: 200,  // 200ms 待機
  pollInterval: 100
}
```
- `/compact` がファイルを段階的に書き込む場合、200ms では不十分な可能性

### 2. **ファイルサイズ変更検出の閾値**
```javascript
Math.abs(stats.size - lastPosition) > 10000  // 10KB
```
- 小さなセッションの圧縮（10KB未満の変更）では検出されない

### 3. **ファイル置換方式の違い**
- `/compact` がアトミックファイル置換を使用している場合（一時ファイル作成 → リネーム）
- 完全に新しいファイルとして認識され、サイズ比較ロジックが機能しない

### 4. **タイミング問題**
- ファイルシステムイベントとファイル内容の実際の利用可能性のずれ
- 特に macOS (APFS) では発生しやすい

## 推奨される修正

### 1. デバウンシング設定の調整
```javascript
awaitWriteFinish: {
  stabilityThreshold: 500,  // より長い安定化時間
  pollInterval: 50          // より頻繁なポーリング
}
```

### 2. 検出閾値の改善
```javascript
const isLikelyCompact = 
  stats.size < lastPosition || 
  Math.abs(stats.size - lastPosition) > 5000 ||  // より低い閾値
  (stats.mtimeMs - lastMtimeMs) > 60000;          // 時間差も考慮
```

### 3. リトライメカニズムの追加
ファイル読み込み失敗時の指数バックオフ実装

### 4. コンテンツハッシュによる検証
ファイルサイズだけでなく、内容の大幅な変更を検出